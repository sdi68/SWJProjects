document.addEventListener("DOMContentLoaded",function(){let imagesFields=document.querySelectorAll('[input-images="container"]');if(imagesFields){imagesFields.forEach(function(e){let enable=true;let form=e.closest("form"),available=e.querySelector('[input-images="available"]'),idField=form.querySelector('input[name*="'+e.getAttribute("data-pk")+'"'),upload=e.querySelector('[input-images="upload"]'),field=e.querySelector('[input-images="field"]'),error=e.querySelector('[input-images="error"]'),loading=e.querySelector('[input-images="loading"]'),result=e.querySelector('[input-images="result"]');let id=e.getAttribute("id"),controller=e.getAttribute("data-controller"),section=e.getAttribute("data-section"),folder=e.getAttribute("data-folder"),pk=(idField)?idField.value*1:0,language=e.getAttribute("data-language"),name=e.getAttribute("data-name");if(pk===0){available.style.display="";enable=false}if(section===""||folder===""||language===""||controller===""){enable=false}if(enable){upload.style.display="";f();upload.addEventListener("dragenter",g,false);upload.addEventListener("dragover",g,false);upload.addEventListener("dragleave",g,false);upload.addEventListener("drop",g,false);upload.addEventListener("dragenter",h,false);upload.addEventListener("dragover",h,false);upload.addEventListener("dragleave",d,false);upload.addEventListener("drop",d,false);upload.addEventListener("drop",function(i){c(i.dataTransfer.files)});field.addEventListener("change",function(i){g(i);c(i.target.files)})}function g(i){i.preventDefault();i.stopPropagation()}function h(){upload.classList.add("dragend")}function d(){upload.classList.remove("dragend")}function f(){error.style.display="none";loading.style.display="";result.style.display="none";let request=new XMLHttpRequest(),requestUrl=controller,formData=new FormData(form);formData.set("task","images.loadImages");formData.set("id",id);formData.set("section",section);formData.set("pk",pk);formData.set("folder",folder);formData.set("language",language);formData.set("name",name);formData.set("values",JSON.stringify(a()));request.open("POST",requestUrl);request.send(formData);request.onreadystatechange=function(){if(this.readyState===4&&this.status===200){let response=false;try{response=JSON.parse(this.response)}catch(i){response=false;error.innerText=i.message;error.style.display="";return}if(response.success){if(response.data){result.innerHTML=response.data.html;b();result.style.display=""}}else{error.innerText=response.message;error.style.display=""}}else{if(this.readyState===4&&this.status!==200){error.innerText=request.status+" "+request.statusText;error.style.display=""}else{if(this.readyState===3){loading.style.display="none"}}}}}function c(i){loading.style.display="";error.style.display="none";result.style.display="none";let request=new XMLHttpRequest(),requestUrl=controller,formData=new FormData(form);formData.set("task","images.uploadImages");formData.set("id",id);formData.set("section",section);formData.set("pk",pk);formData.set("folder",folder);formData.set("language",language);formData.set("name",name);formData.set("values",JSON.stringify(a()));Array.from(i).forEach(function(j){formData.append("images[]",j)});request.open("POST",requestUrl);request.send(formData);request.onreadystatechange=function(){if(this.readyState===4&&this.status===200){let response=false;try{response=JSON.parse(this.response)}catch(j){response=false;result.style.display="";error.innerText=j.message;error.style.display="";return}if(response.success){f()}else{result.style.display="";error.innerText=response.message;error.style.display=""}}else{if(this.readyState===4&&this.status!==200){result.style.display="";error.innerText=request.status+" "+request.statusText;error.style.display=""}else{if(this.readyState===3){loading.style.display="none"}}}}}function b(){if(result.querySelectorAll('[input-images="image"]')){dragula([result.querySelector(".images")]).on("drop",function(){result.querySelectorAll('[input-images="image"]').forEach(function(i,j){i.querySelector(' [input-images="ordering"]').value=j+1})});result.querySelectorAll('[input-images="image"]').forEach(function(i){let preview=i.querySelector('[input-images="preview"]'),imgLoading=i.querySelector('[input-images="image_loading"]');if(preview.getAttribute("src")===""){preview.setAttribute("src",i.querySelector('[input-images="noimage"]').getAttribute("src"));i.querySelector('[input-images="noimage"]').style.display="none";preview.style.display=""}let current=preview.getAttribute("src");i.querySelector('[input-images="view"]').addEventListener("click",function(j){g(j);openPopup(preview.getAttribute("src"),"")});i.querySelector('[input-images="image_field"]').addEventListener("change",function(j){g(j);preview.style.display="none";error.style.display="none";imgLoading.style.display="";let request=new XMLHttpRequest(),requestUrl=controller,formData=new FormData(form);formData.set("task","images.changeImages");formData.set("id",id);formData.set("section",section);formData.set("pk",pk);formData.set("folder",folder);formData.set("language",language);formData.set("filename",j.target.getAttribute("data-key"));Array.from(j.target.files).forEach(function(k){formData.append("images[]",k)});request.open("POST",requestUrl);request.send(formData);request.onreadystatechange=function(){if(this.readyState===4&&this.status===200){let response=false;try{response=JSON.parse(this.response)}catch(k){response=false;preview.setAttribute("src",current);preview.style.display="";error.innerText=k.message;error.style.display="";return}if(response.success){preview.setAttribute("src",(response.data)?response.data:current);preview.style.display=""}else{preview.setAttribute("src",current);error.innerText=response.message;error.style.display=""}}else{if(this.readyState===4&&this.status!==200){i.setAttribute("src",current);preview.style.display="";error.innerText=request.status+" "+request.statusText;error.style.display=""}else{if(this.readyState===3){imgLoading.style.display="none"}}}}});i.querySelector('[input-images="delete"]').addEventListener("click",function(j){g(j);loading.style.display="";error.style.display="none";result.style.display="none";let request=new XMLHttpRequest(),requestUrl=controller,formData=new FormData(form);formData.set("task","images.deleteImages");formData.set("id",id);formData.set("section",section);formData.set("pk",pk);formData.set("folder",folder);formData.set("language",language);formData.set("filename",j.target.getAttribute("data-key"));request.open("POST",requestUrl);request.send(formData);request.onreadystatechange=function(){if(this.readyState===4&&this.status===200){let response=false;try{response=JSON.parse(this.response)}catch(k){response=false;result.style.display="";error.innerText=k.message;error.style.display="";return}if(response.success){i.remove();f()}else{preview.setAttribute("src",current);error.innerText=response.message;error.style.display=""}}else{if(this.readyState===4&&this.status!==200){result.style.display="";error.innerText=request.status+" "+request.statusText;error.style.display=""}else{if(this.readyState===3){loading.style.display="none"}}}}})})}}function a(){let value={},fields=form.querySelectorAll('[name*="'+name+'"]');if(fields){fields.forEach(function(i){let selector=i.getAttribute("data-key"),type=i.getAttribute("data-type");if(!value[selector]){value[selector]={}}value[selector][type]=i.value})}return value}})}});